name: Tag Branch
on:
  workflow_dispatch:
    inputs:
      evt:
        description: 'Select environment/event'
        required: true
        type: choice
        options:
          - evt
          - dev
          - qa
          - prod
      branch:
        description: 'Branch name to tag'
        required: true

jobs:
  tag_branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  

      - name: Validate branch exists and create tag
        env:
          BRANCH: ${{ github.event.inputs.branch }}
          EVT: ${{ github.event.inputs.evt }}
        run: |
          set -e

          echo "Validating branch $BRANCH exists..."

          # Check branch remotely without full fetch, more efficient
          if git ls-remote --heads origin "$BRANCH" | grep "$BRANCH" >/dev/null; then
            echo "Branch $BRANCH found."
          else
            echo "Branch $BRANCH not found in remote origin."
            exit 1
          fi

          echo "Checking out branch $BRANCH"
          git checkout $BRANCH

          DATETIME=$(date +'%Y%m%d%H%M%S')
          TAG="${BRANCH}-${EVT}-${DATETIME}"

          echo "Creating tag: $TAG"
          git tag $TAG

          echo "Pushing tag $TAG to origin"
          git push origin $TAG

          echo "Tag $TAG created and pushed successfully."