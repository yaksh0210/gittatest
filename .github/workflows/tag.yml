name: Tag Branch

on:
  workflow_dispatch:
    inputs:
      evt:
        description: 'Select environment/event'
        required: true
        type: choice
        options:
          - evt
          - dev
          - qa
          - prod
      branch:
        description: 'Branch name to tag'
        required: true

jobs:
  tag_branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with PAT
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.NEW_TOKEN }}
          fetch-depth: 0  # Ensure full history for tagging

      - name: Validate branch, create and push tag
        env:
          BRANCH: ${{ github.event.inputs.branch }}
          EVT: ${{ github.event.inputs.evt }}
        run: |
          set -e

          echo "Validating if branch '$BRANCH' exists on remote..."
          if git ls-remote --heads origin "$BRANCH" | grep "$BRANCH" >/dev/null; then
            echo "Branch '$BRANCH' found."
          else
            echo "Branch '$BRANCH' not found in remote origin."
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Checking out branch '$BRANCH'..."
          git checkout "$BRANCH"

          DATETIME=$(date +'%d%m%Y%H%M')
          TAG="${BRANCH}-${EVT}-${DATETIME}"
          echo "Creating tag: $TAG"
          git tag "$TAG"

          echo "Pushing tag '$TAG' to origin..."
          git push origin "$TAG"

          echo "âœ… Tag '$TAG' created and pushed successfully."
