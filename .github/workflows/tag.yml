name: Tag Branch
on:
  workflow_dispatch:
    inputs:
      evt:
        description: 'Select environment/event'
        required: true
        type: choice
        options:
          - evt
          - dev
          - qa
          - prod
      branch:
        description: 'Branch name to tag'
        required: true

jobs:
  tag_branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # fetch all history for tags

      - name: Run tag creation script
        env:
          BRANCH: ${{ github.event.inputs.branch }}
          EVT: ${{ github.event.inputs.evt }}
        run: |
          #!/bin/bash
          set -e

          echo "Checking if branch $BRANCH exists..."
          git fetch origin

          if git show-ref --verify --quiet refs/remotes/origin/$BRANCH; then
            echo "Branch $BRANCH found."
          else
            echo "Branch $BRANCH not found in remote origin."
            exit 1
          fi

          git checkout $BRANCH

          DATETIME=$(date +'%Y%m%d%H%M%S')
          TAG="${BRANCH}-${EVT}-${DATETIME}"

          echo "Creating tag $TAG"
          git tag $TAG

          echo "Pushing tag $TAG"
          git push origin $TAG
