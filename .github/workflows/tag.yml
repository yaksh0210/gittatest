name: Tag Branch

on:
  workflow_dispatch:
    inputs:
      evt:
        description: 'Select environment/event'
        required: true
        type: choice
        options:
          - evt
          - dev
          - qa
          - prod
      branch:
        description: 'Branch name to tag'
        required: true

jobs:
  tag_branch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Required to push tags

      - name: Validate branch, create and push tag
        env:
          BRANCH: ${{ github.event.inputs.branch }}
          EVT: ${{ github.event.inputs.evt }}
          PAT_TOKEN: ${{ secrets.NEW_TOKEN }}
        run: |
          set -e

          echo "Validating if branch '$BRANCH' exists on remote..."
          if git ls-remote --heads origin "$BRANCH" | grep "$BRANCH" >/dev/null; then
            echo "Branch '$BRANCH' found."
          else
            echo "Branch '$BRANCH' not found in remote origin."
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Checking out branch '$BRANCH'..."
          git checkout $BRANCH

          DATETIME=$(date +'%Y%m%d%H%M%S')
          TAG="${BRANCH}-${EVT}-${DATETIME}"
          echo "Creating tag: $TAG"
          git tag "$TAG"

          echo "Updating remote to use PAT_TOKEN..."
          git remote set-url origin https://x-access-token:${PAT_TOKEN}@github.com/yaksh0210/gittatest.git

          echo "Pushing tag '$TAG' to origin..."
          git push origin "$TAG"

          echo "Tag '$TAG' created and pushed successfully."